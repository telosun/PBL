<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>í•™ìŠµ ì§„í–‰ Â· Unity WebGL (íŒŒì¼ íƒìƒ‰ê¸° ì¶”ê°€)</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/spoqa/spoqa-han-sans/css/SpoqaHanSansNeo.css">

    <style>
        :root {
            --gap: 20px;
            --card-pad: 20px;
            --panel-h: 252px;
            --right-gutter: 20px;
            --bg-grad-start: #D8E5FD;
            --bg-grad-end: #86AFF9;
            --blue: #256EF4;
            --gray-1: #F6F6F6;
            --gray-2: #E3E3E3;
            --text: #000;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: 'Spoqa Han Sans Neo', Pretendard, system-ui, -apple-system, sans-serif;
            background: linear-gradient(180deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            background-attachment: fixed;
        }

        .right-sky {
            position: fixed;
            inset: auto 0 0 auto;
            top: 0;
            right: 0;
            width: var(--right-gutter);
            height: 100vh;
            background: linear-gradient(180deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            pointer-events: none;
            z-index: 10;
        }

        .page {
            display: flex;
            flex-direction: column;
            gap: var(--gap);
            padding: var(--gap);
            padding-right: calc(var(--gap) + var(--right-gutter));
            background: transparent;
        }

        .main-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .split {
            display: flex;
            flex-direction: row;
            gap: var(--gap);
            align-items: flex-start;
            flex-wrap: nowrap;
        }

        .left-col,
        .right-col {
            flex: 1 1 50%;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bottom {
            display: flex;
            flex-direction: row;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: nowrap;
        }

        .mission-col,
        .result-col {
            flex: 1 1 50%;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 0px;
        }

        .title-bar {
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-bar .wrap {
            flex: 1 1 0;
            padding: 8px 10px;
            background: #D8E5FD;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-bar .left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .label-chip {
            padding: 4px 10px;
            background: #fff;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blue);
            font: 700 20px 'Spoqa Han Sans Neo';
            line-height: 28px;
        }

        .title-txt {
            color: #000;
            font: 700 20px 'Spoqa Han Sans Neo';
            line-height: 28px;
        }

        .webgl {
            height: 552px;
            border-radius: 8px;
            border: 1px solid var(--gray-2);
            overflow: hidden;
            position: relative;
            background: #000;
        }

        #unity-canvas {
            width: 100%;
            height: 100%;
            display: block;
            background: #000;
        }

        .hud-badge {
            position: absolute;
            z-index: 3;
            pointer-events: none;
        }

        .hud-left {
            left: 8px;
            top: 8px;
        }

        .hud-right {
            right: 8px;
            top: 8px;
        }

        .hud-card {
            padding: 10px 12px;
            background: rgba(0, 0, 0, .35);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
        }

        .round-36 {
            width: 36px;
            height: 36px;
            background: #D9D9D9;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* â˜…â˜…â˜… íŒŒì¼ íƒìƒ‰ê¸° + ì—ë””í„° ì˜ì—­ â˜…â˜…â˜… */
        .editor-area {
            height: 632px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* íŒŒì¼ íƒìƒ‰ê¸° + Monaco ì—ë””í„°ë¥¼ ë‚˜ë€íˆ ë°°ì¹˜ */
        .code-workspace {
            flex: 1 1 auto;
            display: flex;
            gap: 0;
            min-height: 0;
            background: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--gray-2);
        }

        /* íŒŒì¼ íƒìƒ‰ê¸° */
        .file-explorer {
            width: 220px;
            background: #252526;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #3e3e42;
        }

        .explorer-header {
            padding: 8px 12px;
            background: #2d2d30;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }

        .explorer-title {
            font: 600 13px 'Spoqa Han Sans Neo';
            color: #cccccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .explorer-actions {
            display: flex;
            gap: 4px;
        }

        .icon-btn {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
            color: #cccccc;
            font-size: 18px;
            line-height: 1;
        }

        .icon-btn:hover {
            background: #3e3e42;
        }

        /* íŒŒì¼ íŠ¸ë¦¬ */
        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 8px 4px;
        }

        .file-tree::-webkit-scrollbar {
            width: 8px;
        }

        .file-tree::-webkit-scrollbar-track {
            background: #252526;
        }

        .file-tree::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 4px;
        }

        .file-item,
        .folder-item {
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #cccccc;
            font: 400 13px 'Spoqa Han Sans Neo';
            user-select: none;
            border-radius: 4px;
            margin: 2px 0;
        }

        .file-item:hover,
        .folder-item:hover {
            background: #2a2d2e;
        }

        .file-item.active {
            background: #094771;
            color: #fff;
        }

        .folder-item {
            font-weight: 500;
        }

        .folder-item .arrow {
            width: 16px;
            height: 16px;
            transition: transform 0.2s;
            color: #cccccc;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .folder-item.open .arrow {
            transform: rotate(90deg);
        }

        .folder-children {
            padding-left: 16px;
            display: none;
        }

        .folder-item.open+.folder-children {
            display: block;
        }

        /* íŒŒì¼/í´ë” ì•„ì´ì½˜ */
        .file-icon,
        .folder-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            text-align: center;
        }

        /* ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ */
        .context-menu {
            position: fixed;
            background: #252526;
            border: 1px solid #454545;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 10000;
            min-width: 180px;
            padding: 4px 0;
        }

        .context-menu-item {
            padding: 8px 16px;
            color: #cccccc;
            font: 400 13px 'Spoqa Han Sans Neo';
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background: #094771;
            color: #fff;
        }

        .context-menu-item.danger:hover {
            background: #c72e2e;
        }

        .context-menu-divider {
            height: 1px;
            background: #454545;
            margin: 4px 0;
        }

        /* ì—ë””í„° íƒ­ */
        .editor-tabs {
            display: flex;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            overflow-x: auto;
            height: 35px;
        }

        .editor-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .editor-tabs::-webkit-scrollbar-thumb {
            background: #424242;
        }

        .editor-tab {
            padding: 8px 12px;
            background: #2d2d30;
            color: #969696;
            font: 400 13px 'Spoqa Han Sans Neo';
            border-right: 1px solid #3e3e42;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            min-width: 100px;
        }

        .editor-tab.active {
            background: #1e1e1e;
            color: #fff;
        }

        .editor-tab:hover:not(.active) {
            background: #2a2d2e;
        }

        .editor-tab .close {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            margin-left: auto;
            font-size: 16px;
            line-height: 1;
        }

        .editor-tab .close:hover {
            background: #555;
            opacity: 1;
        }

        /* ì—ë””í„° ì˜ì—­ */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .codebox {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            background: #1e1e1e;
        }

        #monaco {
            flex: 1;
            min-height: 0;
        }

        .btn-row {
            display: flex;
            gap: 16px;
        }

        .btn {
            flex: 1 1 0;
            height: 48px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font: 500 16px 'Spoqa Han Sans Neo';
        }

        .btn.run {
            background: #256EF4;
            color: #fff;
        }

        .btn.copy {
            background: #D8E5FD;
            outline: 1px #0B50D0 solid;
            color: #0B50D0;
        }

        .mission-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mission-title {
            font: 700 20px 'Spoqa Han Sans Neo';
        }

        .mission-tabs {
            padding: 4px 6px;
            background: #D8E5FD;
            border-radius: 6px;
            display: flex;
            align-items: center;
        }

        .mission-tabs .slot {
            width: 71px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #646464;
            font: 500 14px 'Spoqa Han Sans Neo';
            padding: 4px 8px;
        }

        .mission-tabs .slot.active {
            background: #fff;
            color: var(--blue);
            border-radius: 100px;
            font-weight: 700;
        }

        .nav-circles {
            display: flex;
            gap: 6px;
        }

        .nav-circles .circle {
            width: 26px;
            height: 26px;
            background: #D8D8D8;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mission-box,
        .result-box {
            height: var(--panel-h);
            padding: 20px;
            background: #F6F6F6;
            border-radius: 8px;
            outline: 1px var(--gray-2) solid;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: auto;
        }

        .result-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
            gap: 12px;
            flex-wrap: nowrap;
        }

        .btn-gray {
            height: 36px;
            padding: 0 12px;
            background: #787878;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font: 500 14px 'Spoqa Han Sans Neo';
            white-space: nowrap;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="right-sky"></div>

    <div class="page">
        <main class="main">
            <section class="main-card">
                <div class="split">
                    <div class="left-col">
                        <div class="title-bar">
                            <div class="wrap" style="background:transparent; padding:0;">
                                <div class="left">
                                    <div class="label-chip">ê³¼ì • 4-1</div>
                                    <div class="title-txt">ì•„í¬ ì›ìë¡œ ë³µì›</div>
                                </div>
                                <div class="right">
                                    <div style="padding:2px 10px; background:#F6F6F6; border-radius:50px;">
                                        <span style="color:#33363D; font:400 12px Pretendard;">ë‚œì´ë„ ì¤‘</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="webgl">
                            <canvas id="unity-canvas" tabindex="-1"></canvas>
                            <div class="hud-badge hud-left">
                                <div class="hud-card">
                                    <div class="round-36" style="background:#86AFF9;"></div>
                                    <div style="display:flex; flex-direction:column; gap:4px;">
                                        <div style="color:#fff; font:700 14px 'Spoqa Han Sans Neo'">ê°ê·¤</div>
                                        <div class="pill"
                                            style="align-self:flex-start; background:#C0C0C0; color:#33363D; font-weight:600;">
                                            Lv.3</div>
                                    </div>
                                </div>
                            </div>
                            <div class="hud-badge hud-right">
                                <div class="hud-card team" style="gap:8px;">
                                    <div style="width:36px; height:36px; background:#86AFF9; border-radius:4px;"></div>
                                    <div style="color:#fff; font:600 14px 'Spoqa Han Sans Neo'">Team 1</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- â˜…â˜…â˜… ì½”ë“œ ì—ë””í„° ì˜ì—­ (íŒŒì¼ íƒìƒ‰ê¸° ì¶”ê°€) â˜…â˜…â˜… -->
                    <div class="right-col">
                        <div style="padding:8px 6px; font:700 20px 'Spoqa Han Sans Neo'">ì½”ë“œ ì—ë””í„°</div>
                        <div class="editor-area">
                            <div class="code-workspace">
                                <!-- ì¢Œì¸¡: íŒŒì¼ íƒìƒ‰ê¸° -->
                                <div class="file-explorer">
                                    <div class="explorer-header">
                                        <span class="explorer-title">íŒŒì¼</span>
                                        <div class="explorer-actions">
                                            <button id="btnNewFile" class="icon-btn" title="ìƒˆ íŒŒì¼">+</button>
                                            <button id="btnNewFolder" class="icon-btn" title="ìƒˆ í´ë”">ğŸ“</button>
                                        </div>
                                    </div>

                                    <div class="file-tree" id="fileTree">
                                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                                    </div>
                                </div>

                                <!-- ìš°ì¸¡: Monaco Editor -->
                                <div class="editor-container">
                                    <div class="editor-tabs" id="editorTabs">
                                        <!-- ì—´ë¦° íŒŒì¼ íƒ­ë“¤ -->
                                    </div>
                                    <div class="codebox">
                                        <div id="monaco"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="btn-row">
                                <div id="btnCopy" class="btn copy">ì½”ë“œ ë³µì‚¬</div>
                                <div id="btnRun" class="btn run">ì½”ë“œ ì‹¤í–‰</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bottom">
                    <div class="mission-col">
                        <div class="mission-head">
                            <div style="display:flex; align-items:center; gap:32px;">
                                <div class="mission-title">ë¯¸ì…˜</div>
                                <div class="mission-tabs">
                                    <div class="slot active">ìˆ˜í–‰ ê³¼ì œ</div>
                                    <div class="slot">ì„¸ë¶€ ë‚´ìš©</div>
                                    <div class="slot">ì œì•½ ì¡°ê±´</div>
                                    <div class="slot">ê°œë°œ í™˜ê²½</div>
                                    <div class="slot">íšë“ ì—­ëŸ‰</div>
                                </div>
                            </div>
                            <div class="nav-circles">
                                <div class="circle" style="background:#A1A1A1;"></div>
                                <div class="circle" style="background:#A1A1A1;"></div>
                            </div>
                        </div>

                        <div class="mission-box">
                            <div style="color:#000; font:400 16px 'Spoqa Han Sans Neo'">
                                <p>1. ê´€ë¦¬ ë¡œë´‡ì— ì ‘ì†í•˜ê¸°</p>
                                <p style="margin-left:20px; margin-top:-10px; color:#646464;">ë…¸íŠ¸ë¶ì„ ì‚¬ìš©í•˜ì—¬ ê´€ë¦¬ ë¡œë´‡ì— ì ‘ì†í•˜ì„¸ìš”.
                                </p>
                                <p>2. ì•”í˜¸ í•´ì œí•˜ê¸°</p>
                                <p style="margin-left:20px; margin-top:-10px; color:#646464;">Hello, World!ë¥¼ ì¶œë ¥í•´ ë¡œë´‡ì˜ ë³´ì•ˆ
                                    ì‹œìŠ¤í…œì„ í•´ì œí•˜ì„¸ìš”.</p>
                            </div>
                        </div>
                    </div>

                    <div class="result-col">
                        <div class="result-head">
                            <div style="font:700 20px 'Spoqa Han Sans Neo'">ê²°ê³¼</div>
                            <div class="btn-gray" id="btnClearLog">ë¡œê·¸ ì‚­ì œ</div>
                        </div>
                        <div class="result-box">
                            <div id="logArea" style="color:#646464; font:400 16px 'Spoqa Han Sans Neo'">[ ì‹¤í–‰ ë¡œê·¸ ìë¦¬ ]
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="Build/Verts_Test.loader.js"></script>
    <script>
        // Monaco Editor CDN ë¡œë“œ
        window.require = { paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.min.js"></script>

    <!-- â˜…â˜…â˜… íŒŒì¼ ê´€ë¦¬ ì‹œìŠ¤í…œ â˜…â˜…â˜… -->
    <script>
        // íŒŒì¼ ê´€ë¦¬ì í´ë˜ìŠ¤
        class FileManager {
            constructor() {
                this.files = this.loadFromStorage() || {
                    'Main/main.py': '# ì—¬ê¸°ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”.\nprint("Hello, World!")\n'
                };
                this.currentFile = 'Main/main.py';
                this.openTabs = ['Main/main.py'];
                this.folders = new Set(['Main']);
            }

            loadFromStorage() {
                try {
                    const data = localStorage.getItem('projectFiles');
                    if (data) {
                        const folders = localStorage.getItem('projectFolders');
                        if (folders) {
                            this.folders = new Set(JSON.parse(folders));
                        }
                        return JSON.parse(data);
                    }
                    return null;
                } catch {
                    return null;
                }
            }

            saveToStorage() {
                try {
                    localStorage.setItem('projectFiles', JSON.stringify(this.files));
                    const foldersArray = Array.from(this.folders);
                    localStorage.setItem('projectFolders', JSON.stringify(foldersArray));
                } catch (e) {
                    console.error('ì €ì¥ ì‹¤íŒ¨:', e);
                }
            }

            createFile(name, parent = '') {
                const fullPath = parent ? `${parent}/${name}` : name;
                if (this.files[fullPath]) {
                    alert('íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
                    return false;
                }
                this.files[fullPath] = '';
                this.saveToStorage();
                return fullPath;
            }

            deleteFile(path) {
                if (!confirm(`${path}ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return false;
                delete this.files[path];
                this.saveToStorage();

                const idx = this.openTabs.indexOf(path);
                if (idx > -1) {
                    this.openTabs.splice(idx, 1);
                }
                if (this.currentFile === path && this.openTabs.length > 0) {
                    this.currentFile = this.openTabs[0];
                }
                return true;
            }

            renameFile(oldPath, newName) {
                if (this.files[newName]) {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.');
                    return false;
                }
                this.files[newName] = this.files[oldPath];
                delete this.files[oldPath];

                const idx = this.openTabs.indexOf(oldPath);
                if (idx > -1) {
                    this.openTabs[idx] = newName;
                }
                if (this.currentFile === oldPath) {
                    this.currentFile = newName;
                }
                this.saveToStorage();
                return true;
            }

            getContent(path) {
                return this.files[path] || '';
            }

            setContent(path, content) {
                this.files[path] = content;
                this.saveToStorage();
            }

            createFolder(name, parent = '') {
                const fullPath = parent ? `${parent}/${name}` : name;
                if (this.folders.has(fullPath)) {
                    alert('í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
                    return false;
                }
                this.folders.add(fullPath);
                this.saveToStorage();
                return fullPath;
            }

            deleteFolder(path) {
                // í´ë” ë‚´ íŒŒì¼ í™•ì¸
                const filesInFolder = Object.keys(this.files).filter(file => file.startsWith(path + '/'));
                const hasFiles = filesInFolder.length > 0;

                const message = hasFiles
                    ? `${path} í´ë”ì™€ ë‚´ë¶€ì˜ ëª¨ë“  íŒŒì¼(${filesInFolder.length}ê°œ)ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                    : `${path} í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

                if (!confirm(message)) return false;

                // í´ë” ë‚´ ëª¨ë“  íŒŒì¼ ì‚­ì œ
                filesInFolder.forEach(file => {
                    delete this.files[file];
                    // ì—´ë¦° íƒ­ì—ì„œë„ ì œê±°
                    const idx = this.openTabs.indexOf(file);
                    if (idx > -1) {
                        this.openTabs.splice(idx, 1);
                    }
                });

                // í•˜ìœ„ í´ë”ë„ ì‚­ì œ
                const foldersToDelete = Array.from(this.folders).filter(folder =>
                    folder === path || folder.startsWith(path + '/')
                );
                foldersToDelete.forEach(folder => this.folders.delete(folder));

                // í˜„ì¬ íŒŒì¼ì´ ì‚­ì œëœ ê²½ìš° ë‹¤ë¥¸ íŒŒì¼ ì—´ê¸°
                if (filesInFolder.includes(this.currentFile)) {
                    const nextFile = this.openTabs[0] || Object.keys(this.files)[0];
                    if (nextFile) {
                        this.currentFile = nextFile;
                    } else {
                        this.currentFile = null;
                    }
                }

                this.saveToStorage();
                return true;
            }

            renameFolder(oldPath, newPath) {
                if (this.folders.has(newPath)) {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í´ë” ì´ë¦„ì…ë‹ˆë‹¤.');
                    return false;
                }

                // í´ë” ì´ë¦„ ë³€ê²½
                this.folders.delete(oldPath);
                this.folders.add(newPath);

                // í•˜ìœ„ í´ë” ê²½ë¡œ ì—…ë°ì´íŠ¸
                const subFolders = Array.from(this.folders).filter(folder =>
                    folder.startsWith(oldPath + '/')
                );
                subFolders.forEach(folder => {
                    this.folders.delete(folder);
                    const newSubPath = folder.replace(oldPath, newPath);
                    this.folders.add(newSubPath);
                });

                // í´ë” ë‚´ íŒŒì¼ ê²½ë¡œ ì—…ë°ì´íŠ¸
                const filesInFolder = Object.keys(this.files).filter(file =>
                    file.startsWith(oldPath + '/')
                );
                filesInFolder.forEach(file => {
                    const newFilePath = file.replace(oldPath, newPath);
                    this.files[newFilePath] = this.files[file];
                    delete this.files[file];

                    // ì—´ë¦° íƒ­ ê²½ë¡œ ì—…ë°ì´íŠ¸
                    const idx = this.openTabs.indexOf(file);
                    if (idx > -1) {
                        this.openTabs[idx] = newFilePath;
                    }

                    // í˜„ì¬ íŒŒì¼ ê²½ë¡œ ì—…ë°ì´íŠ¸
                    if (this.currentFile === file) {
                        this.currentFile = newFilePath;
                    }
                });

                this.saveToStorage();
                return true;
            }

            deleteFolder(path) {
                // í´ë” ë‚´ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
                const hasFiles = Object.keys(this.files).some(filePath =>
                    filePath.startsWith(path + '/')
                );

                if (hasFiles) {
                    if (!confirm(`${path} í´ë”ì™€ ë‚´ë¶€ì˜ ëª¨ë“  íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return false;
                    }
                    // í´ë” ë‚´ ëª¨ë“  íŒŒì¼ ì‚­ì œ
                    Object.keys(this.files).forEach(filePath => {
                        if (filePath.startsWith(path + '/')) {
                            delete this.files[filePath];
                            // ì—´ë ¤ìˆëŠ” íƒ­ì—ì„œë„ ì œê±°
                            const idx = this.openTabs.indexOf(filePath);
                            if (idx > -1) {
                                this.openTabs.splice(idx, 1);
                            }
                        }
                    });
                } else {
                    if (!confirm(`${path} í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return false;
                    }
                }

                // í´ë” ì‚­ì œ
                this.folders.delete(path);

                // í•˜ìœ„ í´ë”ë„ ì‚­ì œ
                Array.from(this.folders).forEach(folder => {
                    if (folder.startsWith(path + '/')) {
                        this.folders.delete(folder);
                    }
                });

                // í˜„ì¬ íŒŒì¼ì´ ì‚­ì œëœ ê²½ìš° ë‹¤ë¥¸ íŒŒì¼ë¡œ ì „í™˜
                if (this.currentFile.startsWith(path + '/')) {
                    const nextFile = this.openTabs[0] || Object.keys(this.files)[0];
                    if (nextFile) {
                        this.currentFile = nextFile;
                    }
                }

                this.saveToStorage();
                return true;
            }

            getFileStructure() {
                const structure = { files: [], folders: {} };

                // í´ë” êµ¬ì¡° ìƒì„±
                this.folders.forEach(folder => {
                    const parts = folder.split('/');
                    let current = structure.folders;
                    let path = '';

                    parts.forEach((part, idx) => {
                        path = path ? `${path}/${part}` : part;
                        if (!current[part]) {
                            current[part] = {
                                name: part,
                                path: path,
                                files: [],
                                folders: {}
                            };
                        }
                        current = current[part].folders;
                    });
                });

                // íŒŒì¼ ë°°ì¹˜
                Object.keys(this.files).forEach(path => {
                    const parts = path.split('/');
                    if (parts.length === 1) {
                        structure.files.push({ name: path, path: path });
                    } else {
                        let current = structure.folders;
                        for (let i = 0; i < parts.length - 1; i++) {
                            if (current[parts[i]]) {
                                if (i === parts.length - 2) {
                                    current[parts[i]].files.push({
                                        name: parts[parts.length - 1],
                                        path: path
                                    });
                                }
                                current = current[parts[i]].folders;
                            }
                        }
                    }
                });

                return structure;
            }
        }

        // ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
        window.fileManager = new FileManager();
        let editor = null;

        // íŒŒì¼ íŠ¸ë¦¬ ë Œë”ë§
        function renderFileTree() {
            const structure = window.fileManager.getFileStructure();
            const container = document.getElementById('fileTree');
            container.innerHTML = '';

            // ë£¨íŠ¸ íŒŒì¼
            structure.files.forEach(file => {
                const item = createFileElement(file.name, file.path);
                container.appendChild(item);
            });

            // í´ë”
            Object.values(structure.folders).forEach(folder => {
                const folderEl = createFolderElement(folder);
                container.appendChild(folderEl);
            });
        }

        function createFileElement(name, path) {
            const div = document.createElement('div');
            div.className = 'file-item';
            if (path === window.fileManager.currentFile) {
                div.classList.add('active');
            }

            const ext = name.split('.').pop();
            const icon = ext === 'py' ? 'ğŸ' : 'ğŸ“„';

            div.innerHTML = `
                <span class="file-icon">${icon}</span>
                <span>${name}</span>
            `;

            div.addEventListener('click', () => openFile(path));
            div.addEventListener('contextmenu', (e) => showContextMenu(e, path, 'file'));

            return div;
        }

        function createFolderElement(folderData) {
            const container = document.createElement('div');

            const folder = document.createElement('div');
            folder.className = 'folder-item';
            folder.innerHTML = `
                <span class="arrow">â–¶</span>
                <span class="folder-icon">ğŸ“</span>
                <span>${folderData.name}</span>
            `;

            const children = document.createElement('div');
            children.className = 'folder-children';

            // ìì‹ íŒŒì¼ë“¤
            folderData.files.forEach(file => {
                const fileEl = createFileElement(file.name, file.path);
                children.appendChild(fileEl);
            });

            // ìì‹ í´ë”ë“¤
            Object.values(folderData.folders).forEach(subFolder => {
                const subFolderEl = createFolderElement(subFolder);
                children.appendChild(subFolderEl);
            });

            folder.addEventListener('click', (e) => {
                // ìš°í´ë¦­ì´ ì•„ë‹ ë•Œë§Œ í† ê¸€
                if (e.button === 0) {
                    e.stopPropagation();
                    folder.classList.toggle('open');
                }
            });

            folder.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showContextMenu(e, folderData.path, 'folder');
            });

            container.appendChild(folder);
            container.appendChild(children);

            return container;
        }

        // íŒŒì¼ ì—´ê¸°
        function openFile(path) {
            window.fileManager.currentFile = path;

            if (!window.fileManager.openTabs.includes(path)) {
                window.fileManager.openTabs.push(path);
            }

            const content = window.fileManager.getContent(path);
            if (editor) {
                editor.setValue(content);
            }

            renderFileTree();
            renderTabs();
        }

        // íƒ­ ë Œë”ë§
        function renderTabs() {
            const container = document.getElementById('editorTabs');
            container.innerHTML = '';

            window.fileManager.openTabs.forEach(path => {
                const tab = document.createElement('div');
                tab.className = 'editor-tab';
                if (path === window.fileManager.currentFile) {
                    tab.classList.add('active');
                }

                const name = path.split('/').pop();
                const ext = name.split('.').pop();
                const icon = ext === 'py' ? 'ğŸ' : 'ğŸ“„';

                tab.innerHTML = `
                    <span>${icon} ${name}</span>
                    <span class="close" data-path="${path}">Ã—</span>
                `;

                tab.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('close')) {
                        openFile(path);
                    }
                });

                tab.querySelector('.close').addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeTab(path);
                });

                container.appendChild(tab);
            });
        }

        // íƒ­ ë‹«ê¸°
        function closeTab(path) {
            const idx = window.fileManager.openTabs.indexOf(path);
            if (idx > -1) {
                window.fileManager.openTabs.splice(idx, 1);
            }

            if (window.fileManager.currentFile === path) {
                const nextFile = window.fileManager.openTabs[0] || Object.keys(window.fileManager.files)[0];
                if (nextFile) {
                    openFile(nextFile);
                } else if (editor) {
                    editor.setValue('');
                }
            }

            renderTabs();
        }

        // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´
        function showContextMenu(e, path, type) {
            e.preventDefault();
            e.stopPropagation();

            const existing = document.querySelector('.context-menu');
            if (existing) existing.remove();

            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';

            if (type === 'file') {
                menu.innerHTML = `
                    <div class="context-menu-item" data-action="rename">âœï¸ ì´ë¦„ ë°”ê¾¸ê¸°</div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item danger" data-action="delete">ğŸ—‘ï¸ ì‚­ì œ</div>
                `;
            } else if (type === 'folder') {
                menu.innerHTML = `
                    <div class="context-menu-item" data-action="newfile">ğŸ“„ ìƒˆ íŒŒì¼</div>
                    <div class="context-menu-item" data-action="newfolder">ğŸ“ ìƒˆ í´ë”</div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" data-action="renamefolder">âœï¸ ì´ë¦„ ë°”ê¾¸ê¸°</div>
                    <div class="context-menu-item danger" data-action="deletefolder">ğŸ—‘ï¸ í´ë” ì‚­ì œ</div>
                `;
            }

            menu.addEventListener('click', (e) => {
                const action = e.target.dataset.action;

                if (action === 'delete') {
                    if (window.fileManager.deleteFile(path)) {
                        renderFileTree();
                        renderTabs();
                    }
                } else if (action === 'rename') {
                    const newName = prompt('ìƒˆ ì´ë¦„:', path);
                    if (newName && window.fileManager.renameFile(path, newName)) {
                        renderFileTree();
                        renderTabs();
                    }
                } else if (action === 'newfile') {
                    const name = prompt('íŒŒì¼ ì´ë¦„:');
                    if (name) {
                        const newPath = window.fileManager.createFile(name, path);
                        if (newPath) {
                            renderFileTree();
                            openFile(newPath);
                        }
                    }
                } else if (action === 'newfolder') {
                    const name = prompt('í´ë” ì´ë¦„:');
                    if (name) {
                        window.fileManager.createFolder(name, path);
                        renderFileTree();
                    }
                } else if (action === 'renamefolder') {
                    const oldName = path.split('/').pop();
                    const newName = prompt('ìƒˆ í´ë” ì´ë¦„:', oldName);
                    if (newName && newName !== oldName) {
                        const parent = path.includes('/') ? path.substring(0, path.lastIndexOf('/')) : '';
                        const newPath = parent ? `${parent}/${newName}` : newName;
                        if (window.fileManager.renameFolder(path, newPath)) {
                            renderFileTree();
                            renderTabs();
                        }
                    }
                } else if (action === 'deletefolder') {
                    if (window.fileManager.deleteFolder(path)) {
                        renderFileTree();
                        renderTabs();
                    }
                }
                menu.remove();
            });

            document.body.appendChild(menu);

            setTimeout(() => {
                document.addEventListener('click', () => {
                    if (menu.parentElement) menu.remove();
                }, { once: true });
            }, 0);
        }

        // ìƒˆ íŒŒì¼/í´ë” ìƒì„±
        document.getElementById('btnNewFile').addEventListener('click', () => {
            const name = prompt('íŒŒì¼ ì´ë¦„ (ì˜ˆ: test.py):');
            if (name) {
                const path = window.fileManager.createFile(name);
                if (path) {
                    renderFileTree();
                    openFile(path);
                }
            }
        });

        document.getElementById('btnNewFolder').addEventListener('click', () => {
            const name = prompt('í´ë” ì´ë¦„:');
            if (name) {
                if (window.fileManager.createFolder(name)) {
                    renderFileTree();
                }
            }
        });

        // ì½”ë“œ ë³µì‚¬
        document.getElementById('btnCopy').addEventListener('click', () => {
            if (editor) {
                const code = editor.getValue();
                navigator.clipboard.writeText(code).then(() => {
                    alert('ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                });
            }
        });

        // ì½”ë“œ ì‹¤í–‰ (ì˜ˆì‹œ)
        document.getElementById('btnRun').addEventListener('click', () => {
            if (editor) {
                const code = editor.getValue();
                const logArea = document.getElementById('logArea');
                logArea.innerHTML = `
                    <div style="color:#000; font-weight:600;">ì‹¤í–‰ ì¤‘...</div>
                    <pre style="margin-top:10px; color:#646464;">${code}</pre>
                `;
                // ì‹¤ì œ ì‹¤í–‰ ë¡œì§ì€ ë°±ì—”ë“œ API ì—°ë™ í•„ìš”
            }
        });

        // ë¡œê·¸ ì‚­ì œ
        document.getElementById('btnClearLog').addEventListener('click', () => {
            document.getElementById('logArea').textContent = '[ ì‹¤í–‰ ë¡œê·¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤ ]';
        });

        // Monaco Editor ë§ˆìš´íŠ¸
        function mountMonaco() {
            require(['vs/editor/editor.main'], function () {
                const mountEl = document.getElementById('monaco');
                editor = monaco.editor.create(mountEl, {
                    value: window.fileManager.getContent(window.fileManager.currentFile),
                    language: 'python',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    minimap: { enabled: false },
                    fontSize: 14,
                    lineNumbers: 'on',
                    padding: { top: 12, bottom: 12 }
                });

                // ì—ë””í„° ë‚´ìš© ë³€ê²½ì‹œ ì €ì¥
                editor.onDidChangeModelContent(() => {
                    const content = editor.getValue();
                    window.fileManager.setContent(window.fileManager.currentFile, content);
                });

                // ì´ˆê¸° ë Œë”ë§
                renderFileTree();
                renderTabs();

                // Main í´ë”ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì—´ë¦° ìƒíƒœë¡œ ì„¤ì •
                setTimeout(() => {
                    const mainFolder = document.querySelector('.folder-item');
                    if (mainFolder) {
                        mainFolder.classList.add('open');
                    }
                }, 100);
            });
        }

        if (window.require && window.require.config) {
            mountMonaco();
        }
    </script>

    <!-- Unity WebGL ì´ˆê¸°í™” -->
    <script>
        var canvas = document.querySelector("#unity-canvas");

        function unityShowBanner(msg, type) {
            console.log('[Unity Banner]', type, msg);
        }

        var buildUrl = "Build";
        var loaderUrl = buildUrl + "/Verts_Test.loader.js";
        var config = {
            arguments: [],
            dataUrl: buildUrl + "/Verts_Test.data",
            frameworkUrl: buildUrl + "/Verts_Test.framework.js",
            codeUrl: buildUrl + "/Verts_Test.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "PBL_test",
            productVersion: "0.1.0",
            showBanner: unityShowBanner,
        };

        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            var meta = document.createElement('meta');
            meta.name = 'viewport';
            meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
            document.getElementsByTagName('head')[0].appendChild(meta);
            canvas.className = "unity-mobile";
        } else {
            canvas.style.width = "960px";
            canvas.style.height = "600px";
        }

        var script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
                console.log('Unity Loading:', Math.round(progress * 100) + '%');
            }).then((unityInstance) => {
                console.log('Unity Loaded!');
            }).catch((message) => {
                console.error('Unity Error:', message);
            });
        };
        document.body.appendChild(script);
    </script>
</body>

</html>
